\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerinnerthemeLightRound}
\RequirePackage{etoolbox}
\RequirePackage{calc}
\RequirePackage{pgfopts}
\RequirePackage{xifthen}
\RequirePackage{xparse}

% ---------- %
% Background %
% ---------- %

\setbeamertemplate{background}
{
  \begin{tikzpicture}
    \useasboundingbox (0,0) rectangle(\the\paperwidth,\the\paperheight);
    \usebeamercolor{palette primary}
    \usebeamercolor{normal text}
    \usebeamercolor{background canvas}

    \draw[
      color=palette primary.fg,
      thin,
      rounded corners = 1pt
    ] ([shift={(.1,.1)}] current bounding box.south west)
      rectangle ([shift={(-.1,-.1)}] current bounding box.north east);

    \clip[rounded corners=1pt] ([shift={(.1,.1)}] current bounding box.south west)
      rectangle ([shift={(-.1,-.1)}] current bounding box.north east);

    \fill[color=palette primary.fg] ([shift={(.1,.1)}] current bounding box.south west) -- +(.15,0) -- +(0,.15) -- cycle;
    \fill[color=palette primary.fg] ([shift={(-.1,.1)}] current bounding box.south east) -- +(-.15,0) -- +(0,.15) -- cycle;
    \fill[color=palette primary.fg] ([shift={(.1,-.1)}] current bounding box.north west) -- +(.15,0) -- +(0,-.15) -- cycle;

    \fill[palette primary.fg]
      ([shift={(0,-.75)}] current page.north east)
      -- ([shift={(-.75,0)}] current page.north east)
      -- +(-.25,0)
      -- ([shift={(0,-1)}] current page.north east)
      -- cycle;

    \fill[palette primary.fg]
      ([shift={(0,-.35)}] current page.north east)
      -- ([shift={(-.35,0)}] current page.north east)
      -- +(-.25,0)
      -- ([shift={(0,-.6)}] current page.north east)
      -- cycle;

    \coordinate (midpoint) at
      ($ ([shift={(0,-.675)}] current page.north east) !.5! ([shift={(-.675,0)}] current page.north east) $);

    \node[
      fill=background canvas.bg,
      circle,
      inner sep=0,
      minimum size=7pt
    ] at (midpoint) {};

    \node[
      draw=palette primary.fg,
      thin,
      circle,
      inner sep=0,
      minimum size=4.5pt
    ] at (midpoint) {};

    \node[
      fill=palette primary.fg,
      thin,
      circle,
      inner sep=0,
      minimum size=1pt
    ] at (midpoint) {};
  \end{tikzpicture}
}

% ----------------------- %
% Title and section pages %
% ----------------------- %

% I actually do not understand how or why this works, or how I would do this
% without this \@nameuse command.
% Source: https://tex.stackexchange.com/a/323638/39313
\def\ps@footline@none{%
  \setbeamertemplate{footline}{}%
  \@nameuse{ps@footline}}

\setbeamertemplate{title page}
{ 
  \thispagestyle{footline@none}
  \begin{tikzpicture}[overlay,remember picture]
    \usebeamercolor{normal text}
    \usebeamercolor{palette primary}
    \usebeamercolor{background canvas}

    \clip
      ([shift={(.1,.1)}] current page.south west) rectangle
      ([shift={(-.1,-.1)}] current page.north east);

    \fill[background canvas.bg] (current page.north east) rectangle +(-2,-2);

    \draw[
      color=palette primary.fg,
      rounded corners = 1pt
    ] ([shift={(-2.1,-.1)}] current page.north east) -- ++(2,0) -- +(0,-2);

    \fill[palette primary.fg] ([shift={(-.1,-.1)}] current page.north east)
      -- +(-.15,0) -- +(0,-.15) -- cycle;

    \fill[palette primary.fg]
      ([shift={(0,-3)}] current page.north west)
      -- ([shift={(3,0)}] current page.north west)
      -- +(2,0)
      -- ([shift={(0,-5)}] current page.north west)
      -- cycle;

    \fill[palette primary.fg]
      ([shift={(0,-5.5)}] current page.north west)
      -- ([shift={(5.5,0)}] current page.north west)
      -- +(2,0)
      -- ([shift={(0,-7.5)}] current page.north west)
      -- cycle;

    \coordinate (midpoint) at
      ($ ([shift={(0,-5.25)}] current page.north west) !.5! ([shift={(5.25,0)}] current page.north west) $);

    \node[
      fill=background canvas.bg,
      circle,
      inner sep=0,
      minimum size=1cm
    ] at (midpoint) {};

    \node[
      draw=palette primary.fg,
      thin,
      circle,
      inner sep=0,
      minimum size=.7cm
    ] at (midpoint) {};

    \node[
      fill=palette primary.fg,
      thin,
      circle,
      inner sep=0,
      minimum size=.1cm
    ] at (midpoint) {};

    \coordinate (title corner) at
      ([shift={(-2em,-2)}] current page.east);

    \usebeamercolor{title page header}
    \ifx\insertsubtitle\@empty%
    % Insert title
    {
      \node[
        text=fg,
        anchor=south east,
        align=right,
        text width=10cm
      ] at (title corner) {%
        \usebeamerfont{title}\parbox{8.5cm}{{\raggedleft \inserttitle\par}}%
      };%
    }
    \else%
    % Insert subtitle, if one exists, doesn't work with overflow
    {
      \node[
        text=fg,
        anchor=south east,
        align=right,
        text width=10cm
      ] at ([yshift=1em]title corner) {%
        \usebeamerfont{title}\inserttitle \\[5pt]
        \usebeamerfont{subtitle}\insertsubtitle
      };%
    }
    \fi%

    %Insert date
    \usebeamercolor{date}
    \node[
      text=fg,
      anchor=south east
    ] (datenode) at 
      ([shift={(-2em, 1em)}] current page.south east) {%
      \usebeamerfont{date}\insertdate%
    };

    \usebeamercolor{author}
    \node[
      text=fg,
      anchor=south east,
      align=right] at (datenode.north east) (author) {%
      \usebeamerfont{author}\insertauthor%
      };
      
  \end{tikzpicture}
}

\setbeamertemplate{section page}
{
  \thispagestyle{footline@none}
  \begingroup
    \centering
    \vskip1cm\par
    \begin{beamercolorbox}[sep=12pt,center]{section title}
      \usebeamerfont{section title}\insertsection\par
    \end{beamercolorbox}
  \endgroup
}

% ------------------ %
% Block environments %
% ------------------ %

\newcommand{\LightTheme@block@begin}[2]{%
  \par\vskip\medskipamount%
  \usebeamercolor{#1}
  \usebeamercolor{#2}
  \ifx\insertblocktitle\@empty\newcommand{\yskiplength}{1.5ex}
  \else\newcommand{\yskiplength}{2ex}
  \fi
  \begin{tikzpicture}
    \node [
      draw=#1.fg,
      fill=#2.bg,
      inner sep = 1ex,
      inner ysep = \yskiplength,
      text width=\paperwidth - 2cm - 5ex, 
      minimum width=\paperwidth - 2cm - 1ex,
      rounded corners=1pt
    ] (BOXCONTENT) \bgroup%
    \begin{minipage}{\textwidth}
    \usebeamerfont{beamer body}%
    \usebeamercolor{#2}%
}

\newcommand{\LightTheme@block@end}[1]{%
    \end{minipage}%
    \egroup;
    \usebeamercolor{#1}
    \ifx\insertblocktitle\@empty
    \else%
    {
      \node[
        fill=#1.bg,
        anchor=west,
        text=#1.fg,
        inner ysep = 1.5pt,
        rounded corners
      ] at ([shift={(5pt,0)}]BOXCONTENT.north west) {\insertblocktitle};
    }
    \fi

    \clip[rounded corners = 1pt] (BOXCONTENT.south west) rectangle (BOXCONTENT.north east);

    \fill[#1.fg] (BOXCONTENT.south west) -- +(.1,0) -- +(0,.1);
    \fill[#1.fg] (BOXCONTENT.south east) -- +(-.1,0) -- +(0,.1);
    \fill[#1.fg] (BOXCONTENT.north west) -- +(.1,0) -- +(0,-.1);
    \fill[#1.fg] (BOXCONTENT.north east) -- +(-.1,0) -- +(0,-.1);

    \node[
      inner sep=0,
      minimum size=1pt,
      fill=#1.fg,
      circle
    ] at ([shift={(225:.12)}] BOXCONTENT.north east) {};
  \end{tikzpicture}
  \vskip\smallskipamount
}

\setbeamertemplate{block begin}
{
  \LightTheme@block@begin{block title}{block body}
}

\setbeamertemplate{block end}
{
  \LightTheme@block@end{block title}
}

\setbeamertemplate{block alerted begin}
{
  \LightTheme@block@begin{block alerted title}{block alerted body}
}

\setbeamertemplate{block alerted end}
{
  \LightTheme@block@end{block alerted title}
}

\NewDocumentEnvironment{greyblock}{m}%
{
  \par\vskip\medskipamount%
  \usebeamercolor{block grey title}
  \usebeamercolor{block grey body}
  \ifthenelse{\isempty{#1}}%
    {\newcommand{\yskiplength}{1.5ex}}%
    {\newcommand{\yskiplength}{2.0ex}}
  \begin{tikzpicture}
    \node [
      draw=block grey title.fg,
      fill=block grey body.bg,
      inner sep = 1ex,
      inner ysep = \yskiplength,
      text width=\paperwidth - 2cm - 5ex, 
      minimum width=\paperwidth - 2cm - 1ex,
      rounded corners=1pt
    ] (BOXCONTENT) \bgroup%
    \begin{minipage}{\textwidth}
    \usebeamerfont{beamer body}%
    \usebeamercolor{block grey body}%
}{
    \end{minipage}%
    \egroup;
    \usebeamercolor{block grey title}
    \ifthenelse{\isempty{#1}}%
    {}%
    {
      \node [
        fill=block grey title.bg,
        anchor=west,
        text=block grey title.fg,
        inner ysep = 0pt,
        rounded corners = 0pt
      ] at ([shift={(5pt,0)}]BOXCONTENT.north west) {#1};}

    \clip[rounded corners = 1pt] (BOXCONTENT.south west) rectangle (BOXCONTENT.north east);

    \fill[block grey title.fg] (BOXCONTENT.south west) -- +(.1,0) -- +(0,.1);
    \fill[block grey title.fg] (BOXCONTENT.south east) -- +(-.1,0) -- +(0,.1);
    \fill[block grey title.fg] (BOXCONTENT.north west) -- +(.1,0) -- +(0,-.1);
    \fill[block grey title.fg] (BOXCONTENT.north east) -- +(-.1,0) -- +(0,-.1);

    \node[
      inner sep=0,
      minimum size=1pt,
      fill=block grey title.fg,
      circle
    ] at ([shift={(225:.12)}] BOXCONTENT.north east) {};
  \end{tikzpicture}
  \vskip\smallskipamount
}
